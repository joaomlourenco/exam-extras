% ==============================
% myexam-extras — structured
% ==============================
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{exam-extras}%
  [2025/10/27 v1.1 Extended macros and layout helpers for exam class]

% --------------------------------------------------
% Package requirements (load before features below)
% --------------------------------------------------
\RequirePackage[most]{tcolorbox}     % for framed boxes / listings
\RequirePackage{multicol}            % multi-column choices
\RequirePackage[inline,shortlabels]{enumitem} % list tuning (choices margins)
\RequirePackage{tikz}                % drawing (encircled labels)

% --------------------------------------------------
% List / layout tweaks for choices & multicols
% --------------------------------------------------
% Avoid indentation of choices
\def\choiceshook{\setlength{\leftmargin}{2em}}

% Multicol spacing to match item spacing
\premulticols=0pt
\multicolsep=\itemsep

% --------------------------------------------------
% Choice label styling (encircled letters)
% --------------------------------------------------
\newcommand\encircle[1]{%
  \tikz[baseline=(X.base)] 
    \node (X) [draw, shape=circle, inner sep=0] {\strut #1};}
\renewcommand\choicelabel{\encircle{\textsf{\thechoice}}}

% --------------------------------------------------
% Question/choice counters & helpers
% --------------------------------------------------
\def\mynumquestions{\@ifundefined{exam@numquestions}{0}{\exam@numquestions}}% total questions
\def\mynumquestionsmcq{\@ifundefined{exam@numquestionsmcq}{1}{\exam@numquestionsmcq}}% MCQ blocks

\NewCommandCopy\oldchoices\choices
\NewCommandCopy\endoldchoices\endchoices

\newif\ifmulticols
\newcounter{exam@numquestionsmcq}

% Rewrap the 'choices' env to optionally enable multicols
\renewenvironment{choices}[1][]{%
  \stepcounter{exam@numquestionsmcq}
  \multicolsfalse
  \ifx\relax#1\relax\else
    \multicolstrue
    \begin{multicols}{#1}\raggedright
  \fi
  \oldchoices
}{%
  \endoldchoices
  \ifmulticols
    \end{multicols}
  \fi
}

% Persist the MCQ counter at end of document
\AtEndDocument{%
  \immediate\write\@mainaux
    {\string\gdef\string\exam@numquestionsmcq{\theexam@numquestionsmcq}}%
}

% --------------------------------------------------
% Question headings & separators
% --------------------------------------------------
\let\oldquestionlabel\questionlabel
\newcommand\myrule[1][1pt]{\makebox[0pt]{\raisebox{2.5ex}{\rule{3\textwidth}{#1}}}}
\renewcommand\questionlabel{\questionseparator\\\oldquestionlabel}

% Visual section breaks inside answer key / printed answers
\def\@newsectiontitle{}
\newif\if@newsection
\@newsectionfalse
\newcommand{\examnewsection}[1][]{\@newsectiontrue\def\@newsectiontitle{\MakeUppercase{#1}}}
\newcommand{\questionseparator}[1][cyan!90!black]{{%
  \ifprintanswers%
    \if@newsection%
      \global\@newsectionfalse%
      \color{#1}%
      \myrule[2pt]%
      {\centering\makebox[0pt][l]{\raisebox{3.5ex}{\hspace*{-\leftmargin}\@newsectiontitle}}}%
    \else\myrule\fi
  \else\myrule\fi%
}}

% --------------------------------------------------
% Correct-choice emphasis (answer key styling)
% --------------------------------------------------
\CorrectChoiceEmphasis{\color{red!80!black}} % could add \bfseries if desired

% --------------------------------------------------
% Bloom tagging (only when printing answers)
% --------------------------------------------------
\newcommand{\BLOOM}[1]{\ifprintanswers\textcolor{blue}{\textbf{[#1] }}\fi}
\newcommand{\Bloom}{\BLOOM}

% --------------------------------------------------
% Float/caption spacing (tight)
% --------------------------------------------------
\setlength{\abovecaptionskip}{2pt plus 0pt minus 2pt}
\setlength{\belowcaptionskip}{2pt plus 0pt minus 2pt}

% --------------------------------------------------
% Part break helper environment
% --------------------------------------------------
\newcounter{XXX}
\newcommand{\exampart}[1]{%
  \end{questions}%
  \setcounter{XXX}{\value{numquestions}}%
  \begin{center}
    \LARGE
    \vspace{2ex}
    \begin{tabular}{p{\linewidth}}
      \toprule
      \centering Part #1\\
      % \bottomrule
    \end{tabular}
  \end{center}
  \begin{questions}
    \setcounter{question}{\value{XXX}}%
}

% --------------------------------------------------
% Boxing helpers (store content once; reuse)
% --------------------------------------------------
\ifcsname fmbox\endcsname\else\newsavebox{\fmbox}\fi
\newcommand{\choicebox}[1]{\sbox{\fmbox}{#1}\usebox{\fmbox}}

% Token pasting helpers
\protected\long\def\appto#1#2{%
  \edef#1{%
    \unexpanded\expandafter{#1#2}%
  }%
}
\protected\long\def\preto#1#2{%
  \edef#1{%
    \unexpanded{#2}%
    \unexpanded\expandafter{#1}%
  }%
}
% \renewcommand{\questionshook}{\preto\thequestiontitle{\vspace{2ex}\hrule}}

% --------------------------------------------------
% Code listing box (tcolorbox + minted engine)
% --------------------------------------------------
\DeclareTCBListing{code}{ m O{} }{%
    colback=white,
    colframe=black!70,
    listing only,
    listing remove caption=true,
    minted language=#1,
    listing engine=minted,
    minted style=material,
    minted options={
        linenos,
        breaklines,
        numbersep=3mm
    },
    width=\linewidth,
    breakable,
    enhanced jigsaw,
    #2
}

% --------------------------------------------------
% Split question layout: left statement / right choices
%   Usage: \begin{splitquestion}[gutter]{right_fraction} ... \end{splitquestion}
% --------------------------------------------------
\newenvironment{splitquestion}[2][4em]{%
  \par%
  \preto{\choices}{\medskip}%
  \newcommand{\nextpart}{%
    \end{minipage}\hfill%
    \begin{minipage}[t]{\sizeright}%
  }%
  \def\sizeleft{\dimexpr\fpeval{(1-#2)}\textwidth-#1\relax}%
  \def\sizeright{#2\textwidth}%
  \begin{minipage}[t]{\sizeleft}%
}{%
  \end{minipage}%
}

% --------------------------------------------------
% Convenience macros for capitalized tokens (pt/EN mixed)
% --------------------------------------------------
\newcommand{\defcapb}[2][]{%
  \ifx\relax#1\relax
    \expandafter\newcommand\csname#2\endcsname{\textbf{#2}\xspace}%
  \else
    \expandafter\newcommand\csname#2\endcsname{\textbf{#1}\xspace}%
  \fi
}
\defcapb{TRUE}
\defcapb{FALSE}
\defcapb[IS]{IS}
\defcapb[IS NOT]{ISNOT}
\defcapb[DOES NOT]{DOESNOT}
\defcapb[NÃO]{NAO}
\defcapb{SIM}
\defcapb[NÃO É]{NAOE}
\defcapb{VERDADEIRA}
\defcapb{VERDADEIRO}
\defcapb{FALSA}
\defcapb{FALSO}

% --------------------------------------------------
% Unicode conveniences (≈)
% --------------------------------------------------
\DeclareUnicodeCharacter{2248}{\ensuremath{\approx}}
